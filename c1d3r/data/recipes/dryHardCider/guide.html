<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">

<dom-module id="c1d3r-dryHardCider">
  <template>
    <style>
      div.content {
        @apply(--layout-vertical);
      }
      div.head {
        @apply(--layout-horizontal);
        color: #333;
        padding-top: 30px;
        padding-bottom: 10px;
      }
      div.step {
        @apply(--layout-horizontal);
        @apply(--shadow-elevation-2dp);
        margin-top: 1px;
        padding: 10px;
        background-color: white;
      }
    </style>

    <div class="content">
      <div class="content-block">
        <div class="head">0 Configuring Juice Properties</div>
        <div class="step">0.0 Add {{data.acidAddInG}} g of ascorbic acid.</div>
        <div class="step">0.1 Add {{data.potassMetaAddInG}} g of potassium metabisulfite.</div>
        <div class="step">0.2 Add {{data.tanninAddInG}} g of wine tannin.</div>
        <div class="step" hidden$="{{!data.isCloudy}}">0.4 Add {{data.pectinaseAddInG}} g of pectic enzyme (pectinase).</div>
      </div>
    </div>

    <!-- Not Yet Done -->
    <div class="content-block">
      <div class="head">1 Sanitization</div>
      <div class="step">1.0 Let liquid rest for 3 hours</div>
    </div>

    <!--<div class="content-block">-->
    <!--<div class="head">Configuring Juice Properties</div>-->
    <!--<div class="step">Acid</div>-->
    <!--<div class="step">Metabisulfite</div>-->
    <!--<div class="step">Tanin</div>-->
    <!--<div class="step">Pectinase</div>-->
    <!--</div>-->
    <!--<div class="content-block">-->
    <!--<div class="head">Sanitization</div>-->
    <!--<div class="step">Let liquid rest for 3 hours</div>-->
    <!--</div>-->
    <!--<div class="content-block">-->
    <!--<div class="head">Yeast Prep</div>-->
    <!--<div class="step">Add Yeast Nutrient</div>-->
    <!--<div class="step">Add Yeast</div>-->
    <!--<div class="step">Stir liquid thoroughly</div>-->
    <!--</div>-->
    <!--<div class="content-block">-->
    <!--<div class="head">First Fermentation</div>-->
    <!--<div class="step">Ferment in air-locked fermentor for 6 days or until 1.010</div>-->
    <!--</div>-->
    <!--<div class="content-block">-->
    <!--<div class="head">Second Fermentation</div>-->
    <!--<div class="step">Transfer and ferment in secondary fermentor for 2 weeks.</div>-->
    <!--</div>-->
    <!--<div class="content-block">-->
    <!--<div class="head">Packaging</div>-->
    <!--<div class="step">Transfer to bottling bucket</div>-->
    <!--<div class="step">Mix-in Priming Sugar thoroughly</div>-->
    <!--<div class="step">Package in bottles</div>-->
    <!--</div>-->
  </template>

  <script>
    Polymer({
      is: 'c1d3r-dryHardCider',

      properties: {
        recipe: Object,
        data: Object,
        isLogging: {
          type: Boolean,
          value: true
        }
      },

      observers: [
        '_recipeChanged(recipe)',
        '_dataChanged(data)',
        '_dataAttrChanged(data.*)',
        // attr
        '_computeAcid(data.juicePh, data.finalPh, data.volumeInL)',
        '_potassMetaAddInG(data.juicePh, data.volumeInL)',
        '_tanninAddInG(data.origTanninLvl ,data.desiredTanninLvl ,data.volumeInL)',
        '_pectinaseAddInG(data.volumeInL)'
      ],


      _recipeChanged(recipe) {
        console.log('[dryHardCider]_recipeChanged', recipe.name);
      },

      _dataChanged(update) {
        console.log('[dryHardCider]_dataChanged', update);
      },

      _dataAttrChanged(evt) {
        if (this.isLogging)
          console.info('[dryHardCider]<' + evt.path + '> => ' + JSON.stringify(evt.value));
      },

      _computeAcid(juicePh, finalPh, volumeInL) {
        let exp10 = (exp) => Math.pow(10, exp);
        let diff = exp10(-finalPh) - exp10(-juicePh);
        let square = (base) => Math.pow(base, 2);
        let multiplier = square(diff) / 7.94E-5 + diff;
        this.set('data.acidAddInG', multiplier * volumeInL * 176.12);
      },

      _potassMetaAddInG(juicePh, volumeInL) {
        let v = ((52.7*(juicePh*juicePh*juicePh) - 459*(juicePh*juicePh) + 1352.6*juicePh - 1338.6) / 0.57) * volumeInL / 1000;
        this.set('data.potassMetaAddInG', v);
      },

      _tanninAddInG(origTanninLvl, desiredTanninLvl, volumeInL) {
        console.assert(origTanninLvl < 0 || origTanninLvl > 10, 'Original tannin level out of scale.');
        console.assert(desiredTanninLvl < 0 || desiredTanninLvl > 10, 'Desired tannin level out of scale.');
        console.assert(origTanninLvl <= desiredTanninLvl, 'Desired tannin must be lower than initial.');
        let diff = desiredTanninLvl - origTanninLvl;
        console.assert(diff <= 10, 'Increase is out of range. (1 to 10 scale)');

        let v = ((diff / 10) * 160) * volumeInL / 1000;
        this.set('data.tanninAddInG', v);
      },

      _pectinaseAddInG(volumeInL) {
        this.set('data.pectinaseAddInG', 528.34 * volumeInL / 1000);
      }
    });
  </script>
</dom-module>
