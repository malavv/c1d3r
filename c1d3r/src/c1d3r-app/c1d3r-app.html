<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="../c1d3r-ui/c1d3r-footer.html">
<link rel="import" href="../c1d3r-data/c1d3r-loader.html">
<link rel="import" href="../c1d3r-ui/c1d3r-splash.html">
<link rel="import" href="../c1d3r-ui/c1d3r-tutorial.html">
<link rel="import" href="../c1d3r-ui/c1d3r-wizard.html">

<dom-module id="c1d3r-app">
  <template>

    <style>
      :host {
        display: block;
        @apply(--layout-vertical);
      }

      iron-pages {
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }
      iron-pages > * {
        @apply(--layout-flex);
      }
    </style>

    <iron-pages selected="{{selected}}">
      <c1d3r-splash recipes="{{recipes}}" on-recipe="recipeSelected"></c1d3r-splash>
      <c1d3r-tutorial on-home="_navHome" on-next="_navRecipe" on-store-skip="_storeSkip"></c1d3r-tutorial>
      <c1d3r-wizard recipe="{{recipe}}" on-home="_navHome"></c1d3r-wizard>
    </iron-pages>

    <c1d3r-footer locale="{{locale}}"></c1d3r-footer>

    <!-- Recipe Data -->
    <c1d3r-loader urls="[[urls]]" recipes="{{recipes}}"></c1d3r-loader>
    <template is="dom-repeat" items="{{urls}}" as="url">
      <c1d3r-recipe url="{{url}}" recipe="{{recipes.#0}}"></c1d3r-recipe>
    </template>

    <iron-localstorage name="c1d3r-app" value="{{data}}" on-iron-localstorage-load-empty="_initData"></iron-localstorage>
  </template>

  <script>
    Polymer({

      is: 'c1d3r-app',

      properties: {
        // Recipes Data Locations
        urls: {
          type: Array,
          value: () => [
            '../../data/recipes/dryHardCider/recipe.json'
          ]
        },

        locale: {
          value: 'en',
          observer: '_localeChanged'
        },
        recipes: {
          type: Array,
          value: () => []
        },
        data: {
          type: Object
        },
        selected: {
          type: Number,
          value: 0,
          observer: '_pageChanged'
        },
        recipe: {
          type: Object,
          notify: true
        }
      },

      ready() {
        this.set('recipes', Polymer.dom(this.root).querySelectorAll('c1d3r-recipe'));
      },

      recipeSelected(evt) {
        console.info('recipe ' + evt.detail.url + ' selected');
        this.$$('iron-pages').selectIndex(this.data.skipTutorial ? 2 : 1);
        this.set('recipe', evt.detail);
      },

      _localeChanged(newLangCode, oldLangCode) {
        console.info('locale changed from ' + oldLangCode + ' to ' + newLangCode);
      },

      _navHome() {
        this.$$('iron-pages').selectIndex(0);
      },

      _initData() {
        this.data = {
          skipTutorial: false
        };
      },

      _storeSkip() {
        console.info('tutorial skipping is now stored ');
        this.set('data.skipTutorial', true);
      },
      _navRecipe() {
        this.$$('iron-pages').selectIndex(2);
      },

      _pageChanged(newPage, oldPage) {
        let pages = this.$$('iron-pages').children;
        if (oldPage != null && pages[oldPage] != null && pages[oldPage].onBlur != null)
          pages[oldPage].onBlur();
        if (newPage != null && pages[newPage] != null && pages[newPage].onFocus != null)
          pages[newPage].onFocus();
      }
    });
  </script>
</dom-module>
