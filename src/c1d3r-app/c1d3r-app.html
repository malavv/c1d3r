<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">


<link rel="import" href="../c1d3r-data/c1d3r-loader.html">
<link rel="import" href="../c1d3r-data/c1d3r-strings.html">
<link rel="import" href="../c1d3r-ui/c1d3r-footer.html">
<link rel="import" href="../c1d3r-ui/c1d3r-splash.html">
<link rel="import" href="../c1d3r-ui/c1d3r-tutorial.html">
<link rel="import" href="../c1d3r-ui/c1d3r-wizard.html">

<dom-module id="c1d3r-app">
  <template>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet">

    <style include="iron-flex"></style>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        height: 100vh;
        --main-bg-color: rgb(242, 242, 242);
        --main-title-font: 'Open Sans Condensed', sans-serif;
      }

      iron-pages {
        overflow-y: auto;
      }
    </style>

    <iron-pages class="layout vertical flex" selected="[[selected]]">
      <c1d3r-splash class="flex" recipes="[[recipes]]" on-selected="_selectRecipe"></c1d3r-splash>
      <c1d3r-tutorial class="flex" on-next="_navRecipe" on-home="_navHome"></c1d3r-tutorial>
      <c1d3r-wizard class="flex" recipe="[[recipe]]" on-home="_navHome"></c1d3r-wizard>
    </iron-pages>

    <c1d3r-footer locale="{{locale}}"></c1d3r-footer>

    <!-- Loads the application manifest -->
    <iron-ajax auto url="/manifest.json" handle-as="json" on-response="_handleManifest"></iron-ajax>

    <!--Load Locale -->
    <c1d3r-strings locale="en" url="/data/strings_en.json"></c1d3r-strings>
  </template>

  <script>
    Polymer({

      is: 'c1d3r-app',

      properties: {
        locale: {
          value: 'en',
          observer: '_localeChanged'
        },
        recipe: {
          type: Object,
          notify: true
        },
        recipes: Array,
        selected: {
          type: Number,
          value: 0,
          observer: '_pageChanged'
        }
      },

      attached() {
        this.set('recipes', Polymer.dom(this).children);
      },

      /**
       * Processes Application Manifest.
       */
      _handleManifest(evt) {
        window.app = evt.detail.response;
        this.$$('c1d3r-footer').setVersion(window.app.version);
      },
      /**
       * On user switched locale
       */
      _localeChanged(newLangCode, oldLangCode) {
        console.info('locale changed from ' + oldLangCode + ' to ' + newLangCode);
        this.fire('iron-signal', {name: 'locale', data: newLangCode});
      },
      /**
       * Navigate to the Home (splash page)
       */
      _navHome() {
        this.set('recipe', undefined);
        this.$$('c1d3r-wizard').reset();
        this.$$('iron-pages').selectIndex(0);
      },
      /**
       * Navigate to the app with a recipe selected.
       */
      _navRecipe() {
        this.set('selected', 2);
      },
      /**
       * Select a specific recipe.
       */
      _selectRecipe(evt) {
        this.set('selected', 1);
        this.set('recipe', evt.detail);
      },
      /**
       * Manages calling onFocus and onBlur during page switching.
       * @param newPage Page moving to
       * @param oldPage Page moving from
       * @private
       */
      _pageChanged(newPage, oldPage) {
        let pages = this.$$('iron-pages').children;
        if (oldPage != null && pages[oldPage] != null && pages[oldPage].onBlur != null)
          pages[oldPage].onBlur();
        if (newPage != null && pages[newPage] != null && pages[newPage].onFocus != null)
          pages[newPage].onFocus();
      }
    });
  </script>
</dom-module>
