<dom-module id="c1d3r-juice">
    <style>
        :host {}
        :host div.questions {
        }
        :host span.idx {
            padding: 0 10px;
            color: #bbb;
            font-weight: bold;
        }
        :host span.label {
            display: inline-block;
            @apply(--layout-flex);
        }
        :host .question input {
            margin-right: 20px;
        }
        :host .question iron-icon {
            margin-right: 20px;
            fill: green;
        }
        :host .question {
            border-bottom: 1px solid #cdcdcd;
            background-color: #fafafa;
            padding: 7px 0;
            @apply(--layout-horizontal);
        }
        :host .invisible {
            visibility: none;
        }
        :host paper-progress {
            width: 100%;
        }
        :host .volume {
            @apply(--layout-horizontal);
        };
        :host .volume paper-input {
            width: 5em;
        };
        :host iron-selector > :not(.iron-selected) {
            display: none;
        }
    </style>

    <template>
        <paper-progress max="[[recipe.questions.length]]" value="[[recipe.numAnswered]]"></paper-progress>
        <template is="dom-repeat" items="{{recipe.questions}}">
            <div class="question">
                <span class="idx">[[index]]</span>
                <span class="label">[[item.label]]</span>
                <iron-selector attr-for-selected="type" selected="{{item.type}}">
                    <div type="boolean">
                        <paper-checkbox noink on-change="onChanged"></paper-checkbox>
                    </div>
                    <div type="text">
                        <paper-input no-label-float on-change="onChanged"></paper-input>
                    </div>
                    <div class="volume" type="volume">
                        <paper-input no-label-float type="number" on-change="onChanged"></paper-input>
                        <paper-radio-group id="radio" on-change="onChanged" selected="L">
                          <paper-radio-button noink name="L">L</paper-radio-button>
                          <paper-radio-button noink name="mL">mL</paper-radio-button>
                          <paper-radio-button noink name="pint">pint</paper-radio-button>
                        </paper-radio-group>
                    </div>
                </iron-selector>

                <iron-icon class$="{{questionClass(item.isAnswered)}}" icon="assignment-turned-in"></iron-icon>
            </div>
        </template>
    </template>

    <script>
    (function() {
    'use strict';

      Polymer({
        is: 'c1d3r-juice',

        properties: {
            recipe: {
                type: Object,
                notify: true
            }
        },

        onEntersView: function() {
            console.debug('c1d3r-juice', 'onEntersView');
        },
        onExitsView: function() {
            console.debug('c1d3r-juice', 'onExitsView');
            this.notifyPath('recipe.steps', this.recipe.steps);
        },
        questionClass: function(isAnswered) {
          var answered = isAnswered || false;
          return answered ? '' : 'invisible';
        },
        onChanged: function(evt)  {
          var
            question = evt.model.__data__.item,
            juiceKeyData = 'juice.' + question.boundTo,
            questionIndexAnswered = 'questions.' + evt.model.index + '.isAnswered';

            this.recipe.set(juiceKeyData, this.extractInfo(evt, question.type));
            this.recipe.set(questionIndexAnswered, true);
            this.recipe.set('numAnswered', this.recipe.getNumberAnswered());
            this.notifyPath('recipe.' + questionIndexAnswered, true);
            this.notifyPath('recipe.numAnswered', this.recipe.numAnswered);
            evt.preventDefault();
        },
        extractInfo: function(evt, type) {
          switch (type) {
            case 'boolean':
              return evt.currentTarget.checked;
            case 'text':
              return evt.currentTarget.value;
            case 'volume':
              var
                magnitude = evt.currentTarget.value || 0,
                unit = evt.model._rootDataHost.querySelector('#radio').selected;
              return magnitude + ' ' + unit;
          }
        }
      });
    })()
    </script>
</dom-module>
