<dom-module id="c1d3r-juice">
  <style>
    :host {}
    :host div.questions {
    }
    :host span.idx {
        padding: 0 10px;
        color: #bbb;
        font-weight: bold;
    }
    :host span.label {
        display: inline-block;
        @apply(--layout-flex);
    }
    :host .question input {
        margin-right: 20px;
    }
    :host .question iron-icon {
        margin-right: 20px;
        fill: green;
    }
    :host .question {
        border-bottom: 1px solid #cdcdcd;
        background-color: #fafafa;
        padding: 7px 0;
        @apply(--layout-horizontal);
    }
    :host .invisible {
        visibility: none;
    }
    :host paper-progress {
        width: 100%;
    }
    :host .volume {
        @apply(--layout-horizontal);
    };
    :host .volume paper-input {
        width: 5em;
    };
    :host iron-selector > :not(.iron-selected) {
        display: none;
    }
  </style>

  <template>
    <paper-progress max="[[questions.length]]" value="{{numAnswered}}"></paper-progress>
    <template is="dom-repeat" items="{{questions}}" id="questionList" observe="isAnswered" as="question">
      <div class="question">
        <span class="idx">[[index]]</span>
        <span class="label">[[question.label]]</span>

        <iron-icon
            hidden$="{{!question.isAnswered}}"
            icon="assignment-turned-in"></iron-icon>

        <iron-selector attr-for-selected="type" selected="[[typeForVariable(question)]]">
          <div type="boolean">
            <paper-checkbox noink on-change="onChanged"></paper-checkbox>
          </div>
          <div type="text">
            <paper-input no-label-float on-change="onChanged"></paper-input>
          </div>
          <div class="volume" type="volume">
            <paper-input no-label-float type="number" on-change="onChanged"></paper-input>
            <paper-radio-group id="radio" on-change="onChanged" selected="L">
              <paper-radio-button noink name="L">L</paper-radio-button>
              <paper-radio-button noink name="mL">mL</paper-radio-button>
              <paper-radio-button noink name="pint">pint</paper-radio-button>
            </paper-radio-group>
          </div>
        </iron-selector>

        
      </div>
    </template>
  </template>

    <script>
    (function() {
    'use strict';

      function isQuestionAnswered(q) {
        return q.isAnswered;
      }

      Polymer({
        is: 'c1d3r-juice',

        properties: {
          data: {
            type: Object,
            notify: true
          },
          questions: {
            type: Array,
            notify: true
          },
          numAnswered: {
            type: Number,
            notify: true
          }
        },

        // We hid the auto computed values because no user input are needed.
        typeForVariable: function(variable) {
          return this.data[variable.variableId].type;
        },
        onEntersView: function() {
            console.debug('c1d3r-juice', 'onEntersView');
        },
        onExitsView: function() {
            console.debug('c1d3r-juice', 'onExitsView');
        },
        onChanged: function(evt)  {
          var 
            q = evt.model.question,
            data = this.data[q.variableId];

          evt.model.set('question.isAnswered', true);
          this.set('data.' + q.variableId + '.value', this.extractInfo(evt, data.type))
          this.numAnswered = this.questions.filter(isQuestionAnswered).length;

          evt.preventDefault();
        },
        extractInfo: function(evt, type) {
          switch (type) {
            case 'boolean':
              return evt.currentTarget.checked;
            case 'text':
              return evt.currentTarget.value;
            case 'volume':
              var
                magnitude = evt.currentTarget.value || 0,
                unit = evt.model._rootDataHost.querySelector('#radio').selected;
              return magnitude + ' ' + unit;
          }
        },
        listObjectValues: function(obj) {
          return Object.keys(obj).map(function(k) { return obj[k]; });
        }
      });
    })()
    </script>
</dom-module>
