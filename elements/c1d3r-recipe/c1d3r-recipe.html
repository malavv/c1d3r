<dom-module id="c1d3r-recipe">
    <script>
    (function() {
        'use strict';
        /**
         * This is the standard recipe but there can be as much as you want.
         */
        Polymer({
            is: 'c1d3r-recipe',

            properties: {
              configuration: {
                type: Object,
                observer: 'newConfig'
              },
              name: {
                type: String,
                notify: true
              },
              data: {
                type: Object,
                notify: true,
                value: function() { return {}; }
              },
              questions: {
                type: Array,
                value: function() { return []; },
                notify: true
              },
              steps: {
                type: Array,
                value: function() { return []; },
                notify: true
              },
              numAnswered: {
                type: Number,
                notify: true
              }
            },

            observers: [
              'recompute(data, data.*)'
            ],

            recompute: function(data) {
              Object.getOwnPropertyNames(this.data).forEach(function(k) {
                var v = this.data[k];
                if (v.type !== "computed")
                  return;
                var evalStr = this._updateEvalStr(v);
                if (evalStr.indexOf("undefined") === -1)
                  this.set('data.' + k + '.value', this._recompute(evalStr));

              }, this);
            },

            _updateEvalStr: function(value) {
              // brute force way
              var evalstr = value.compute;
              Object.getOwnPropertyNames(this.data).forEach(function(k) {
                var re = new RegExp(k, 'g');
                evalstr = evalstr.replace(re, this.data[k].value);
              }, this);
              return evalstr;
            },

            _recompute: function(evalStr) {
              return eval(evalStr);
            },

            newConfig: function(ciderConf) {
              this.name = ciderConf.name;
              this.questions = ciderConf.questions;
              this.questions.forEach(function(q) { 
                q.isAnswered = ciderConf.data[q.variableId].type === 'boolean'; 
              }, this);


              Object.getOwnPropertyNames(ciderConf.data).map(function(key) {
                var val = ciderConf.data[key];
                val.name = key;
                if (val.type === 'boolean')
                  val.value = false;
              }, this);

              this.data = ciderConf.data;
              ciderConf.steps.forEach(function(step) {
                if (step.type === 'if')
                  step.isHidden = true;
              });
              this.steps = ciderConf.steps;
              this.steps

              // Boolean default to false.
              this.set('numAnswered', 1);
              console.info('Loading new recipe config', ciderConf);
            },

            ready: function() {
            },
            getNumberAnswered: function() {
              return this.questions.filter(function(q) { return q.isAnswered; }).length;
            },
            makeStepLabel: function(data) {
              var token = data.text.split("{}"), arr = [];
              if (token.length <= 1) {
                arr.push({
                  kind: '',
                  content: token[0]
                });
              }
              if (token.length == 2) {
                arr.push({
                  kind: '',
                  content: token[0]
                });
                arr.push({
                  kind: 'quantity',
                  content: data.value + ' ' + data.symbol
                });
                arr.push({
                  kind: '',
                  content: token[1]
                });
              }
              return {
                cmpt: arr
              }
            }
        });
    })()
    </script>
</dom-module>