<dom-module id="c1d3r-recipe">
    <style>
        :host {}
    </style>

    <template>

        <h1>C1d3r : The recipe</h1>
    </template>

    <script>
    (function() {
        'use strict';
        /**
         * This is the standard recipe but there can be as much as you want.
         */
        Polymer({
            is: 'c1d3r-recipe',

            properties: {
              configuration: {
                type: Object,
                observer: 'newConfig'
              },
              name: {
                type: String,
                notify: true
              },
              data: {
                type: Object,
                notify: true,
                value: function() { return {}; }
              },

              questions: {
                type: Array,
                value: function() { return []; },
                notify: true
              },

              // Steps to make the cider.
              steps: {
                type: Array,
                value: function() { return []; },
                notify: true
              },
              numAnswered: {
                type: Number,
                notify: true
              }
            },

            observers: [
              'juiceDataChanged(juice.*)'
            ],

            newConfig: function(ciderConf) {
              this.name = ciderConf.name;
              this.questions = ciderConf.questions;
              this.questions.forEach(function(q) { 
                q.isAnswered = ciderConf.data[q.variableId].type === 'boolean'; 
              }, this);


              Object.getOwnPropertyNames(ciderConf.data).map(function(key) {
                var val = ciderConf.data[key];
                val.name = key;
                if (val.type === 'boolean')
                  val.value = false;
              }, this);

              this.data = ciderConf.data;
              ciderConf.steps.forEach(function(step) {
                if (step.type === 'if')
                  step.isHidden = true;
              });
              this.steps = ciderConf.steps;
              this.steps

              // Boolean default to false.
              this.set('numAnswered', 1);
              console.log('newConfig', ciderConf);
            },

            juiceDataChanged: function(val) {
              if (this.steps === undefined)
                return;
              this.clearSteps();
              this.buildSteps();
              this.notifyPath('steps', this.steps);
            },
            ready: function() {
            },
            getNumberAnswered: function() {
              return this.questions.filter(function(q) { return q.isAnswered; }).length;
            },
            clearSteps: function() {
              while(this.steps.length > 0) this.pop('steps');
            },
            makeStepLabel: function(data) {
              var token = data.text.split("{}"), arr = [];
              if (token.length <= 1) {
                arr.push({
                  kind: '',
                  content: token[0]
                });
              }
              if (token.length == 2) {
                arr.push({
                  kind: '',
                  content: token[0]
                });
                arr.push({
                  kind: 'quantity',
                  content: data.value + ' ' + data.symbol
                });
                arr.push({
                  kind: '',
                  content: token[1]
                });
              }
              return {
                cmpt: arr
              }
            },
            buildSteps: function() {
              console.log(this.name + ' Building Steps');

              if (this.juice.isUnsuitable) {
                this.steps.push(this.makeStepLabel({
                  text: "This juice is unsuitable for cider making, you may continue at your own risk."
                }));
              }

              if (this.juice.isCloudy && this.juice.volume) {
                this.steps.push(this.makeStepLabel({
                  text: "Add {} of pectic enzyme.",
                  value: this.juice.volume.replace("L", "") * 0.264 * 0.5,
                  symbol: "tsp"
                }));
              }
            }
        });
    })()
    </script>
</dom-module>