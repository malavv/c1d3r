<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="../../bower_components/web-component-tester/browser.js"></script>
  <link rel="import" href="../../elements/elements.html">
  <link rel="import" href="../../elements/c1d3r-recipe/c1d3r-recipe.html">
</head>
<body>
  <template id="t" is="dom-bind">
    <iron-ajax auto
        url="../../data/hard-cider.json"
        handle-as="json"
        last-response="{{ciderConf}}"></iron-ajax>
    <c1d3r-recipe id="fixture" configuration="[[ciderConf]]"></c1d3r-recipe>
  </template>
  <script>
    function deltaEqual(lhs, rhs, delta) {
      return Math.abs(lhs - rhs) < delta;
    }

    suite('<c1d3r-recipe>', function() {
      test('Base recipe verification.', function() {
        var recipe = document.getElementById('fixture')
        recipe.configuration = recipeConfig;
        assert.isTrue(recipe.is === "c1d3r-recipe");

        // Enter recipe parameters
        Object.getOwnPropertyNames(config).forEach(function(key) {
          recipe.set('data.' + key + '.value', config[key]);
        }, this);

        // Check computations.
        Object.getOwnPropertyNames(results).forEach(function(key) {
          var
            expected = results[key],
            value = recipe.data[key].value;

          switch(typeof(expected)) {
            case 'number':
              // Times 1 is conversion from string to number. Thx JS! (sic)
              assert.closeTo(value * 1, new Number(expected), 0.01, key);
              break;
            case 'boolean':
              assert.strictEqual(value, expected, key);
              break;
            default:
              console.warn('we need : ' + typeof(expected));
          }
        }, this);      
      });
    });
    var 
      recipeConfig = {
        "name": "Hard Cider",

        "questions": [
          {
            "label": "Does the juice has preservatives; sorbates, sorbitol, or sulfite?",
            "variableId": "isUnsuitable"
          },
          {
            "label": "Is the juice cloudy?",
            "variableId": "isCloudy"
          },
          {
            "label": "How much liquid?",
            "variableId": "volumeInL"
          },
          {
            "label": "Measure the original gravity of the juice. (ex. 1.020)",
            "variableId": "og"
          },
          {
            "label": "What is the efficiency of your yeast?",
            "variableId": "yeastEfficiency"
          },
          {
            "label": "How much alcohol do you want in percent? Suggest > 7.0 for long storage.",
            "variableId": "degreeAlcool"
          },
          {
            "label": "What is the ppg of your sugar.",
            "variableId": "sugarPpg"
          },
          {
            "label": "From 0 (no tannin) to 5 (full blown tannin)",
            "variableId": "tanninLvl"
          },
          {
            "label": "What is the PH of the juice?",
            "variableId": "juicePh"
          },
          {
            "label": "What is required PH of the juice?",
            "variableId": "finalPh"
          }
        ],

        "data": {
          "isUnsuitable": { "type": "boolean" },
          "isCloudy": { "type" : "boolean" },
          "volumeInL": { "type" : "volume" },
          "og": { "type" : "text" },
          "liters2gallons": {
            "type" : "computed",
            "compute": "(1/3.78541)"
          },
          "kg2lb": {
            "type" : "computed",
            "compute": "2.20462262"
          },
          "tspPecticEnzymeInG": {
            "type" : "computed",
            "compute": "4.0"
          },
          "tspPotassMetaInG": {
            "type" : "computed",
            "compute": "6.2"
          },
          "tspYeastNutrientInG": {
            "type" : "computed",
            "compute": "3.3"
          },
          "tspWineTanninInG": {
            "type" : "computed",
            "compute": "2.8"
          },
          "pecticEnzymeInG": {
            "type" : "computed",
            "compute": "(1/2) * {{volumeInL}} * {{liters2gallons}} * {{tspPecticEnzymeInG}}"
          },
          "potassMetaInG": {
            "type" : "computed",
            "compute": "(1/4) * (1/5) * {{volumeInL}} * {{liters2gallons}} * {{tspPotassMetaInG}}"
          },
          "yeastNutrientInG": {
            "type" : "computed",
            "compute": "(1/4) * {{volumeInL}} * {{liters2gallons}} * {{tspYeastNutrientInG}}"
          },
          "yeastEfficiency": { "type" : "text" },
          "degreeAlcool": { "type" : "text" },
          "sugarPpg": { "type" : "text" },
          "sugarPKgL": {
            "type" : "computed",
            "compute": "({{sugarPpg}} / 1000) * (1/{{liters2gallons}}) * {{kg2lb}}"
          },
          "additionalGravity": {
            "type" : "computed",
            "compute": "1 - {{og}} + ({{degreeAlcool}}/(131.25*{{yeastEfficiency}}))"
          },
          "chaptizeSugarKg": {
            "type" : "computed",
            "compute": "({{additionalGravity}}*{{volumeInL}})/{{sugarPKgL}}"
          },
          "tanninLvl": { "type" : "text" },
          "tanninG": {
            "type": "computed",
            "compute": "(1/4) * {{volumeInL}} * {{liters2gallons}} * {{tspWineTanninInG}} * ({{tanninLvl}}/5)"
          },
          "acidAddition": {
            "type" : "computed",
            "compute": "0"
          },
          "juicePh": { "type" : "text" },
          "finalPh": { "type" : "text" }
        },

        "steps": [
          {
            "hidden": "!{{isUnsuitable}}",
            "template": "This juice is unsuitable for cider making, you may continue at your own risk."
          },
          {
            "hidden": "!{{isCloudy}}",
            "template": "Add {{pecticEnzymeInG}} g of pectic enzyme."
          },
          {
            "template": "Add {{potassMetaInG}} g of potassium metabisulfite. Blend with juice first to dissolve."
          },
          {
            "template": "Allow 3 hours for potassium metabisulfite to act."
          },
          {
            "template": "Add yeast nutrient. Roughly {{yeastNutrientInG}} g, could need more as fermentation goes."
          },
          {
            "template": "Add your sugar. {{chaptizeSugarKg}} kg to achieve the alcohol you requested."
          },
          {
            "template": "Add {{acidAddition}} g of ascetic acid to achieve required PH."
          },
          {
            "template": "Add {{tanninG}} g of wine tannin."
          },
          {
            "template": "Add English ale yeast"
          },
          {
            "template": "Stir yeast in."
          },
          {
            "template": "Think to add ~.5% ABV for bottle priming"
          }
        ]
      },
      config = {
        isUnsuitable: false,
        isCloudy: true,
        volumeInL: 23,
        og: 1.042,
        yeastEfficiency: 0.75,
        degreeAlcool: 7.0,
        sugarPpg: 46,
        tanninLvl: 3,
        juicePh: 5.5,
        finalPh: 4.5
      },
      results = {
        pecticEnzymeInG: 13.8,
        potassMetaInG: 4.06, // See wiki for computation.
        yeastNutrientInG: 5.7,
        sugarPKgL: 0.3,
        additionalGravity: 0,
        chaptizeSugarKg: 0,
        tanninG: 2.9,
        acidAddition: 0
      };
  </script>
</body>
</html>