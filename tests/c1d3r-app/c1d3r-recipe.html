<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="../../bower_components/web-component-tester/browser.js"></script>
  <link rel="import" href="../../elements/elements.html">
  <link rel="import" href="../../elements/c1d3r-recipe/c1d3r-recipe.html">
</head>
<body>
  <template id="t" is="dom-bind">
    <iron-ajax auto
        url="../../data/hard-cider.json"
        handle-as="json"
        last-response="{{ciderConf}}"></iron-ajax>
    <c1d3r-recipe id="fixture" configuration="[[ciderConf]]"></c1d3r-recipe>
  </template>
  <script>
    function deltaEqual(lhs, rhs, delta) {
      return Math.abs(lhs - rhs) < delta;
    }

    suite('<c1d3r-recipe>', function() {
      test('Base recipe verification.', function() {
        var recipe = document.getElementById('fixture')
        recipe.configuration = recipeConfig;
        assert.isTrue(recipe.is === "c1d3r-recipe");

        // Enter recipe parameters
        Object.getOwnPropertyNames(config).forEach(function(key) {
          recipe.set('data.' + key + '.value', config[key]);
        }, this);

        // Check computations.
        Object.getOwnPropertyNames(results).forEach(function(key) {
          var
            expected = results[key],
            value = recipe.data[key].value;

          switch(typeof(expected)) {
            case 'number':
              // Times 1 is conversion from string to number. Thx JS! (sic)
              assert.closeTo(value * 1, new Number(expected), 0.01, key);
              break;
            case 'boolean':
              assert.strictEqual(value, expected, key);
              break;
            default:
              console.warn('we need : ' + typeof(expected));
          }
        }, this);
      });
    });
    var
      recipeConfig = {
        "name": "Hard Cider",

        "questions": [
          {
            "label": "Does the juice has preservatives; sorbates, sorbitol, or sulfite?",
            "variableId": "isUnsuitable"
          },
          {
            "label": "Is the juice cloudy?",
            "variableId": "isCloudy"
          },
          {
            "label": "How much liquid?",
            "variableId": "volumeInL"
          },
          {
            "label": "Measure the original gravity of the juice. (ex. 1.020)",
            "variableId": "og"
          },
          {
            "label": "What is the efficiency of your yeast?",
            "variableId": "yeastEfficiency"
          },
          {
            "label": "How much alcohol do you want in percent? Suggest > 7.0 for long storage.",
            "variableId": "degreeAlcool"
          },
          {
            "label": "What is the ppg of your sugar.",
            "variableId": "sugarPpg"
          },
          {
            "label": "From 0 (no tannin) to 10 (full blown tannin)",
            "variableId": "tanninLvl"
          },
          {
            "label": "What is the PH of the juice?",
            "variableId": "juicePh"
          },
          {
            "label": "What is required PH of the juice?",
            "variableId": "finalPh"
          }
        ],

        "data": {
          "isUnsuitable": { "type": "boolean" },
          "isCloudy": { "type" : "boolean" },
          "volumeInL": { "type" : "volume" },
          "og": { "type" : "text" },
          "tanninLvl": { "type" : "text" },
          "yeastEfficiency": { "type" : "text" },
          "degreeAlcool": { "type" : "text" },
          "sugarPpg": { "type" : "text" },
          "juicePh": { "type" : "text" },
          "finalPh": { "type" : "text" },

          "pecticEnzymeInG": {
            "type" : "computed",
            "compute": "528.34 * {{volumeInL}} / 1000"
          },
          "potassMetaInG": {
            "type" : "computed",
            "compute": "((52.7*({{juicePh}}*{{juicePh}}*{{juicePh}}) - 459*({{juicePh}}*{{juicePh}}) + 1352.6*{{juicePh}} - 1338.6) / 0.57) * {{volumeInL}} / 1000"
          },
          "yeastNutrientInG": {
            "type" : "computed",
            "compute": "217.94 * {{volumeInL}} / 1000"
          },
          "chaptizeSugarKg": {
            "type" : "computed",
            "compute": "((((4 * {{degreeAlcool}})/(525 * {{yeastEfficiency}}) - {{og}} + 1) * 1000) / ({{sugarPpg}} * 2.20462 * 3.78541)) * {{volumeInL}}"
          },
          "tanninG": {
            "type": "computed",
            "compute": "(({{tanninLvl}} / 10) * 160) * {{volumeInL}} / 1000"
          },
          "acidAddition": {
            "type" : "computed",
            "compute": "(Math.pow((Math.pow(10, -{{finalPh}}) - Math.pow(10, -{{juicePh}})), 2) / 7.94E-5 + (Math.pow(10, -{{finalPh}}) - Math.pow(10, -{{juicePh}}))) * {{volumeInL}} * 176.12"
          }
        },

        "steps": [
          {
            "hidden": "!{{isUnsuitable}}",
            "template": "This juice is unsuitable for cider making, you may continue at your own risk."
          },
          {
            "hidden": "!{{isCloudy}}",
            "template": "Add {{pecticEnzymeInG}} g of pectic enzyme."
          },
          {
            "template": "Add {{potassMetaInG}} g of potassium metabisulfite. Blend with juice first to dissolve."
          },
          {
            "template": "Allow 3 hours for potassium metabisulfite to act."
          },
          {
            "template": "Add yeast nutrient. Roughly {{yeastNutrientInG}} g, could need more as fermentation goes."
          },
          {
            "template": "Add your sugar. {{chaptizeSugarKg}} kg to achieve the alcohol you requested."
          },
          {
            "template": "Add {{acidAddition}} g of ascetic acid to achieve required PH."
          },
          {
            "template": "Add {{tanninG}} g of wine tannin."
          },
          {
            "template": "Add English ale yeast"
          },
          {
            "template": "Stir yeast in."
          },
          {
            "template": "Think to add ~.5% ABV for bottle priming"
          }
        ]
      },
      config = {
        isUnsuitable: false,
        isCloudy: true,
        volumeInL: 23,
        og: 1.042,
        yeastEfficiency: 0.75,
        degreeAlcool: 7.0,
        sugarPpg: 46,
        tanninLvl: 4.0,
        juicePh: 4.0,
        finalPh: 3.5
      },
      // See wiki for computation.
      results = {
        pecticEnzymeInG: 12.15, // Verified,
        potassMetaInG: 4.06, // Verified
        yeastNutrientInG: 5.01, // Verified
        chaptizeSugarKg: 1.74, // Verified
        tanninG: 1.47, // Verified
        acidAddition: 3.26 // Verified
      };
  </script>
</body>
</html>