<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">

<dom-module id="c1d3r-dryHardCider">
  <template>
    <style>
      div.content {
        @apply(--layout-vertical);
      }
      div.head {
        @apply(--layout-horizontal);
        color: #333;
        padding-top: 30px;
        padding-bottom: 10px;
      }
      div.step {
        @apply(--layout-horizontal);
        @apply(--shadow-elevation-2dp);
        margin-top: 1px;
        padding: 10px;
        background-color: white;
      }
    </style>

    <div class="content">
      <!--Initial Prep-->
      <div class="content-block">
        <div class="head">0 Configuring Juice Properties</div>
        <div class="step">0.0 Add {{data.acidAddInG}} g of ascorbic acid.</div>
        <div class="step">0.1 Add {{data.potassMetaAddInG}} g of potassium metabisulfite.</div>
        <div class="step">0.2 Add {{data.tanninAddInG}} g of wine tannin.</div>
        <div class="step" hidden$="{{!data.isCloudy}}">0.3 Add {{data.pectinaseAddInG}} g of pectic enzyme (pectinase).</div>
      </div>
      <!--Sanitization-->
      <div class="content-block">
        <div class="head">1 Sanitization</div>
        <div class="step">1.0 Let liquid rest for 3 hours. (Under appropriate cover and in a cleaned space)</div>
      </div>
      <!--Yeast Preparation-->
      <div class="content-block">
        <div class="head">2 Yeast Prep</div>
        <div class="step">2.0 Add {{data.nutrientAddInG}} g of Yeast Nutrient.</div>
        <div class="step">2.1 Add the content of a Yeast packet from your favorite manufacturer; White Labs WLP007, or Wyeast 1098, or Safale S-04</div>
        <div class="step">2.2 Mix-in {{data.chaptizationSugarAddKg}} kg of table sugar thoroughly.</div>
        <div class="step">2.3 Stir liquid thoroughly for at least 2 minutes.</div>
        <div class="step">2.4 Be warned that due to the sugar addition, the final volume will increase from {{data.volumeInL}} to {{data.addedVolumeOfSugarAddInL}} L.</div>

      </div>
      <!--First Fermentation-->
      <div class="content-block">
        <div class="head">3 First Fermentation</div>
        <div class="step">3.0 Ferment in an air-locked fermentor for 5 days or until 1.010.</div>
      </div>
      <!--Second Fermentation-->
      <div class="content-block">
        <div class="head">4 Second Fermentation</div>
        <div class="step">4.0 Transfer and ferment in secondary fermentor for 2 weeks or until desired dryness.</div>
      </div>
      <!-- Packaging and Bottling -->
      <div class="content-block">
        <div class="head">5 Packaging</div>
        <div class="step">5.0 Transfer to bottling bucket.</div>
        <div class="step">5.1 Mix-in {{data.primingSugarAddKg}} kg of priming sugar (table sugar) thoroughly.</div>
        <div class="step">5.2 Package in bottles.</div>
      </div>
    </div>
  </template>

  <script>
    const poundsInKg = 2.20462;
    const litresInGal = 3.78541;

    Polymer({
      is: 'c1d3r-dryHardCider',

      properties: {
        recipe: Object,
        data: {
          type: Object,
          notify: true
        },
        isLogging: {
          type: Boolean,
          value: false
        }
      },

      observers: [
        '_recipeChanged(recipe)',
        '_dataChanged(data)',
        '_dataAttrChanged(data.*)',
        // attr
        '_computeAcid(data.juicePh, data.finalPh, data.volumeInL)',
        '_potassMetaAddInG(data.finalPh, data.volumeInL)',
        '_tanninAddInG(data.origTanninLvl ,data.desiredTanninLvl ,data.volumeInL)',
        '_pectinaseAddInG(data.volumeInL)',
        '_nutrientAddInG(data.volumeInL)',
        '_chaptizationSugarAddKg(data.degreeAlcool, data.yeastEfficiency, data.og, data.sugarYieldPtsKgL, data.volumeInL)',
        '_primingSugarAddKg(data.sugarPpg, data.volumeInL)',
        '_tg(data.og, data.sugarYieldPtsKgL, data.chaptizationSugarAddKg, data.volumeInL)',
        '_addedVolumeOfSugarAddInL(data.og, data.chaptizationSugarAddKg, data.volumeInL, data.tg)',
        '_sugarYieldPtsKgL(data.sugarPpg)'
      ],

      _recipeChanged(recipe) {
        if (recipe == null)
          return;
        console.log('[dryHardCider]_recipeChanged', recipe.name);
      },
      _dataChanged(update) {
        console.log('[dryHardCider]_dataChanged', update);
      },
      _dataAttrChanged(evt) {
        if (this.isLogging)
          console.info('[dryHardCider]<' + evt.path + '> => ' + JSON.stringify(evt.value));
      },
      _computeAcid(juicePh, finalPh, volumeInL) {
        let exp10 = (exp) => Math.pow(10, exp);
        let diff = exp10(-finalPh) - exp10(-juicePh);
        let square = (base) => Math.pow(base, 2);
        let multiplier = square(diff) / 7.94E-5 + diff;
        let value = multiplier * volumeInL * 176.12;
        this.set('data.acidAddInG', this._toReal(value));
      },
      _potassMetaAddInG(finalPh, volumeInL) {
        let value = ((52.7*(finalPh*finalPh*finalPh) - 459*(finalPh*finalPh) + 1352.6*finalPh - 1338.6) / 0.57) * volumeInL / 1000;
        this.set('data.potassMetaAddInG', this._toReal(value));
      },
      _tanninAddInG(origTanninLvl, desiredTanninLvl, volumeInL) {
        const maxTanninPerLInGram = 0.160;
        const maxScale = 10;
        let
          oTannin = this._fromString(origTanninLvl),
          dTannin = this._fromString(desiredTanninLvl),
          volume = this._fromString(volumeInL);

        if (oTannin == null || dTannin == null || volume == null)
          this.set('data.tanninAddInG', null);

        let normalizedDiff = (dTannin - oTannin) / maxScale;
        console.assert(oTannin >= 0 && oTannin <= 10, 'Original tannin level out of scale.');
        console.assert(dTannin >= 0 && dTannin <= 10, 'Desired tannin level out of scale.');
        console.assert(oTannin <= dTannin, 'Desired tannin must be lower than initial.');
        console.assert(normalizedDiff >= 0 && normalizedDiff <= 1, 'Increase is out of range. (0 to 10 scale)');

        this.set('data.tanninAddInG', this._toReal(normalizedDiff * maxTanninPerLInGram * volume));
      },
      _pectinaseAddInG(volumeInL) {
        let value = 528.34 * volumeInL / 1000;
        this.set('data.pectinaseAddInG', this._toReal(value));
      },
      _nutrientAddInG(volumeInL) {
        let value = 217.94 * volumeInL / 1000;
        this.set('data.nutrientAddInG', this._toReal(value));
      },
      _chaptizationSugarAddKg(degreeAlcool, yeastEfficiency, juiceGravity, sugarYieldPtsKgL, volumeInL) {
        let
          abv = this._fromString(degreeAlcool),
          yeast = this._fromString(yeastEfficiency),
          og = this._fromString(juiceGravity),
          volume = this._fromString(volumeInL);

        if (abv == null || yeast == null || og == null || volume == null || sugarYieldPtsKgL == null)
          this.set('data.chaptizationSugarAddKg', null);

        console.assert(abv >= 3 && abv <= 8, 'ABV out of recipe bounds');
        console.assert(yeast >= 0.0 && yeast <= 1.0, 'Yeast efficiency between 0 and 1');
        console.assert(og >= 1.000 && og <= 1.100, 'Invalid Original Gravity in SG');
        console.assert(volume >= 0, 'Volume must be positive');

        let value = ((((4 * abv) / (525 * yeast) - og + 1) * 1000) / sugarYieldPtsKgL) * volume;
        console.assert(value >= 0, 'ABV too low with respect to juice gravity, get more than ' + abv);
        this.set('data.chaptizationSugarAddKg', value < 0 ? 0 : this._toReal(value));
      },
      _primingSugarAddKg(sugarPpg, volumeInL) {
        // Assuming 2.5 Volumes of CO2 at 20C and Table Sugar.
        // This is not a technical formula, just a bug fix before cider
        // season. This is coming from
        // http://www.brewersfriend.com/beer-priming-calculator/
        this.set('data.primingSugarAddKg', this._toReal(6.55 * volumeInL/1000));
      },
      /**
       * Total Gravity
       *
       * @param og Original Gravity in specific Gravity
       * @param sugarPpg Potency of the sugar in Pts per pound per gallon.
       * @param volumeInL Volume in Litre
       */
      _tg(juiceGravity, sugarYieldPtsPerKgPerL, chaptizationSugarAddKg, volumeInL) {
        let
          og = this._fromString(juiceGravity),
          volume = this._fromString(volumeInL);

        if (og == null || sugarYieldPtsPerKgPerL == null || chaptizationSugarAddKg == null || volumeInL == null)
          this.set('data.tg', null);

        console.assert(og >= 1.000 && og <= 1.100, 'Invalid Original Gravity in SG');
        console.assert(chaptizationSugarAddKg >= 0, 'Cannot have negative sugar addition');
        console.assert(volume >= 0, 'Cannot have negative volume');
        this.set('data.tg', og + ((chaptizationSugarAddKg / volume) * sugarYieldPtsPerKgPerL) / 1000);
      },
      /**
       * Converts Imperial Sugar Yield to Metric.
       *
       * We normally demand the input directly in metric, but since all standard
       * table provide the ppg value, we accept it as is and than convert it
       * manually.
       *
       * @param sugarPpg Sugar Yield of Milli-Gravity points per pond per gal.
       * @return Yield in milli-points of gravity per kg per L.
       */
      _sugarYieldPtsKgL(sugarPpg) {
        let yield = this._fromString(sugarPpg);
        console.assert(yield == null || yield > 30 && yield < 50, 'Invalid PPG value (30 < x < 50)');
        // No toReal since this is not meant to be shown.
        this.set('data.sugarYieldPtsKgL', yield == null ? null : yield * poundsInKg * litresInGal);
      },
      _addedVolumeOfSugarAddInL(juiceGravity, chaptizationSugarAddKg, volumeInL, tg) {
        let
          og = this._fromString(juiceGravity),
          volume = this._fromString(volumeInL);

        if (og == null || tg == null || chaptizationSugarAddKg == null || volume == null)
          this.set('data.tg', null);

        console.assert(og >= 1.000 && og <= 1.100, 'Invalid Original Gravity in SG');
        console.assert(chaptizationSugarAddKg >= 0, 'Cannot have negative sugar addition');
        console.assert(volume >= 0, 'Cannot have negative volume');

        let mass = og * volume + chaptizationSugarAddKg;
        this.set('data.addedVolumeOfSugarAddInL', this._toReal(mass / tg));
      },

      _toReal(real) {
        if (real % 1 == 0)
          return real;

        if (real < 0)
          return Number(real.toString().slice(0, 6));
        return Number(real.toString().slice(0, 5))
      },
      _fromString(val) {
        if (val == null)
          return val;
        if (typeof val === 'number')
          return val;
        console.assert(typeof val === 'string', 'Invalid value type. Should be a String.');
        if (val.trim().length === 0)
          return null;
        return Number(val);
      },
      listSteps() {
        let instructions = Array.from(Polymer.dom(this.root).querySelectorAll('.content-block'));
        let extract = steps => {
          return {
            text: steps[0].innerText,
            steps: steps.slice(1)
                .filter(s => !s.hidden)
                .map(s => s.innerText)
          };
        };

        return instructions
            .map(block => Array.from(block.children))
            .map(steps => extract(steps));
      }
    });
  </script>
</dom-module>
