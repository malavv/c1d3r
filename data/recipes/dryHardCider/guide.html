<html><head><link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">

</head><body><dom-module id="c1d3r-dryHardCider">
  <template>
    <style>
      div.content {
        @apply(--layout-vertical);
      }
      div.head {
        @apply(--layout-horizontal);
        color: #333;
        padding-top: 30px;
        padding-bottom: 10px;
      }
      div.step {
        @apply(--layout-horizontal);
        @apply(--shadow-elevation-2dp);
        margin-top: 1px;
        padding: 10px;
        background-color: white;
      }
    </style>

    <div class="content">
      
      <div class="content-block">
        <div class="head">0 Configuring Juice Properties</div>
        <div class="step">0.0 Add {{data.acidAddInG}} g of ascorbic acid.</div>
        <div class="step">0.1 Add {{data.potassMetaAddInG}} g of potassium metabisulfite.</div>
        <div class="step">0.2 Add {{data.tanninAddInG}} g of wine tannin.</div>
        <div class="step" hidden$="{{!data.isCloudy}}">0.3 Add {{data.pectinaseAddInG}} g of pectic enzyme (pectinase).</div>
      </div>
      
      <div class="content-block">
        <div class="head">1 Sanitization</div>
        <div class="step">1.0 Let liquid rest for 3 hours</div>
      </div>
      
      <div class="content-block">
        <div class="head">2 Yeast Prep</div>
        <div class="step">2.0 Add {{data.nutrientAddInG}} g of Yeast Nutrient.</div>
        <div class="step">2.1 Add the content of a Yeast packet.</div>
        <div class="step">2.3 Stir liquid thoroughly for 2 minutes.</div>
      </div>
      
      <div class="content-block">
        <div class="head">3 First Fermentation</div>
        <div class="step">3.0 Ferment in an air-locked fermentor for 5 days or until 1.010.</div>
      </div>
      
      <div class="content-block">
        <div class="head">4 Second Fermentation</div>
        <div class="step">4.0 Transfer and ferment in secondary fermentor for 2 weeks or until desired dryness.</div>
      </div>
      
      <div class="content-block">
        <div class="head">5 Packaging</div>
        <div class="step">5.0 Transfer to bottling bucket.</div>
        <div class="step">5.1 Mix-in {{data.chaptizationSugarAddKg}} kg of priming sugar (table sugar) thoroughly.</div>
        <div class="step">5.2 Package in bottles.</div>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'c1d3r-dryHardCider',

      properties: {
        recipe: Object,
        data: {
          type: Object,
          notify: true
        },
        isLogging: {
          type: Boolean,
          value: false
        }
      },

      observers: [
        '_recipeChanged(recipe)',
        '_dataChanged(data)',
        '_dataAttrChanged(data.*)',
        // attr
        '_computeAcid(data.juicePh, data.finalPh, data.volumeInL)',
        '_potassMetaAddInG(data.finalPh, data.volumeInL)',
        '_tanninAddInG(data.origTanninLvl ,data.desiredTanninLvl ,data.volumeInL)',
        '_pectinaseAddInG(data.volumeInL)',
        '_nutrientAddInG(data.volumeInL)',
        '_chaptizationSugarAddKg(data.degreeAlcool, data.yeastEfficiency, data.og, data.sugarPpg, data.volumeInL)'
      ],

      _recipeChanged(recipe) {
        if (recipe == null)
          return;
        console.log('[dryHardCider]_recipeChanged', recipe.name);
      },
      _dataChanged(update) {
        console.log('[dryHardCider]_dataChanged', update);
      },
      _dataAttrChanged(evt) {
        if (this.isLogging)
          console.info('[dryHardCider]<' + evt.path + '> => ' + JSON.stringify(evt.value));
      },
      _computeAcid(juicePh, finalPh, volumeInL) {
        let exp10 = (exp) => Math.pow(10, exp);
        let diff = exp10(-finalPh) - exp10(-juicePh);
        let square = (base) => Math.pow(base, 2);
        let multiplier = square(diff) / 7.94E-5 + diff;
        let value = multiplier * volumeInL * 176.12;
        this.set('data.acidAddInG', this._toReal(value));
      },
      _potassMetaAddInG(finalPh, volumeInL) {
        let value = ((52.7*(finalPh*finalPh*finalPh) - 459*(finalPh*finalPh) + 1352.6*finalPh - 1338.6) / 0.57) * volumeInL / 1000;
        this.set('data.potassMetaAddInG', this._toReal(value));
      },
      _tanninAddInG(origTanninLvl, desiredTanninLvl, volumeInL) {
        console.assert(origTanninLvl < 0 || origTanninLvl > 10, 'Original tannin level out of scale.');
        console.assert(desiredTanninLvl < 0 || desiredTanninLvl > 10, 'Desired tannin level out of scale.');
        console.assert(origTanninLvl <= desiredTanninLvl, 'Desired tannin must be lower than initial.');
        let diff = desiredTanninLvl - origTanninLvl;
        console.assert(diff <= 10, 'Increase is out of range. (1 to 10 scale)');

        let value = ((diff / 10) * 160) * volumeInL / 1000;
        this.set('data.tanninAddInG', this._toReal(value));
      },
      _pectinaseAddInG(volumeInL) {
        let value = 528.34 * volumeInL / 1000;
        this.set('data.pectinaseAddInG', this._toReal(value));
      },
      _nutrientAddInG(volumeInL) {
        let value = 217.94 * volumeInL / 1000;
        this.set('data.nutrientAddInG', this._toReal(value));
      },
      _chaptizationSugarAddKg(degreeAlcool, yeastEfficiency, og, sugarPpg, volumeInL) {
        let value = ((((4 * degreeAlcool)/(525 * yeastEfficiency) - og + 1) * 1000) / (sugarPpg * 2.20462 * 3.78541)) * volumeInL;
        this.set('data.chaptizationSugarAddKg', this._toReal(value));
      },

      _toReal(real) {
        if (real % 1 == 0)
          return real;

        if (real < 0)
          return Number(real.toString().slice(0, 6));
        return Number(real.toString().slice(0, 5))
      },

      listSteps() {
        let instructions = Array.from(Polymer.dom(this.root).querySelectorAll('.content-block'));
        let extract = steps => {
          return {
            text: steps[0].innerText,
            steps: steps.slice(1)
                .filter(s => !s.hidden)
                .map(s => s.innerText)
          };
        };

        return instructions
            .map(block => Array.from(block.children))
            .map(steps => extract(steps));
      }
    });
  </script>
</dom-module>
</body></html>